name: üîí Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.8.6'

jobs:
  # Dependency vulnerability scanning
  dependency-check:
    name: üîç Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'QQQ'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: >
            --failOnCVSS 7
            --enableRetired
            --suppression suppression.xml

      - name: Upload dependency check results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'reports');
              const files = fs.readdirSync(reportPath);
              const htmlFile = files.find(f => f.endsWith('.html'));
              
              if (htmlFile) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `üîí **Security Audit Complete**\n\nDependency vulnerability scan completed. [View full report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                });
              }
            } catch (error) {
              console.log('Could not create comment:', error.message);
            }

  # Code security analysis with CodeQL
  codeql-analysis:
    name: üîê CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

  # Maven security plugin checks
  maven-security:
    name: üõ°Ô∏è Maven Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Maven
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          maven-version: ${{ env.MAVEN_VERSION }}

      - name: Run Maven Security Plugin
        run: |
          mvn org.sonatype.ossindex.maven:ossindex-maven-plugin:audit
          mvn org.owasp:dependency-check-maven:check

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maven-security-reports
          path: target/

  # Container security (if using Docker)
  container-scan:
    name: üê≥ Container Security Scan
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'docker') || contains(github.event.head_commit.message, 'container')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.sarif

  # License compliance check
  license-check:
    name: üìú License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Check license headers
        run: |
          mvn license:check
        continue-on-error: true

      - name: Generate license report
        run: |
          mvn license:report

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: target/

  # Security policy compliance
  security-policy:
    name: üìã Security Policy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check security files exist
        run: |
          echo "Checking security-related files..."
          test -f SECURITY.md && echo "‚úÖ SECURITY.md exists" || echo "‚ùå SECURITY.md missing"
          test -f CODE_OF_CONDUCT.md && echo "‚úÖ CODE_OF_CONDUCT.md exists" || echo "‚ùå CODE_OF_CONDUCT.md missing"
          test -f .github/ISSUE_TEMPLATE/bug_report.md && echo "‚úÖ Bug report template exists" || echo "‚ùå Bug report template missing"

      - name: Validate security policy
        run: |
          echo "Validating security policy content..."
          if grep -q "security@kingsrook.com" SECURITY.md; then
            echo "‚úÖ Security contact email found"
          else
            echo "‚ùå Security contact email not found"
            exit 1
          fi

  # Notify on security issues
  security-notification:
    name: üîî Security Notifications
    runs-on: ubuntu-latest
    needs: [dependency-check, codeql-analysis, maven-security]
    if: always()
    steps:
      - name: Check for security issues
        id: check-issues
        run: |
          if [ "${{ needs.dependency-check.result }}" == "failure" ] || \
             [ "${{ needs.codeql-analysis.result }}" == "failure" ] || \
             [ "${{ needs.maven-security.result }}" == "failure" ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Create security issue
        if: steps.check-issues.outputs.has_issues == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Security Audit Failed - Action Required',
              body: `## Security Audit Failure

              One or more security checks have failed in the latest security audit.

              **Failed Jobs:**
              ${context.needs.dependency-check.result === 'failure' ? '- ‚ùå Dependency Vulnerability Scan' : '- ‚úÖ Dependency Vulnerability Scan'}
              ${context.needs.codeql-analysis.result === 'failure' ? '- ‚ùå CodeQL Security Analysis' : '- ‚úÖ CodeQL Security Analysis'}
              ${context.needs.maven-security.result === 'failure' ? '- ‚ùå Maven Security Checks' : '- ‚úÖ Maven Security Checks'}

              **Action Required:**
              Please review the [security audit run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) and address any security issues found.

              **Security Contact:**
              For immediate security concerns, contact security@kingsrook.com

              ---
              *This issue was automatically created by the security audit workflow.*`,
              labels: ['security', 'high-priority', 'needs-attention']
            });
            console.log(`Created security issue: ${issue.data.html_url}`);
