version: 2.1

orbs:
  localstack: localstack/platform@2.1
  browser-tools: circleci/browser-tools@1.4.7

commands:
  mvn_build:
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          name: Write .env
          command: |
            echo "RDBMS_PASSWORD=$RDBMS_PASSWORD" >> qqq-sample-project/.env
      - run:
          name: Run Maven Compile
          command: |
            mvn -s .circleci/mvn-settings.xml -T4 --no-transfer-progress compile
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

  mvn_verify:
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Run Maven Verify
          command: |
            mvn -s .circleci/mvn-settings.xml -T4 --no-transfer-progress verify
      - run:
          name: Collect JaCoCo reports
          command: .circleci/collect-jacoco-reports.sh
          when: always
      - store_artifacts:
          path: /home/circleci/jacoco-reports
          destination: jacoco-reports
          when: always
      - run:
          name: Concatenate test output files
          command: .circleci/concatenate-test-output.sh
          when: always
      - store_artifacts:
          path: /home/circleci/test-output-artifacts
          destination: test-output
          when: always
      - run:
          name: Save test results
          command: |
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - store_test_results:
          path: ~/test-results

  check_middleware_api_versions:
      steps:
        - checkout
        - restore_cache:
            keys:
              - v1-dependencies-{{ checksum "pom.xml" }}
        - run:
            name: Build and Run ValidateApiVersions
            command: |
              mvn -s .circleci/mvn-settings.xml -T4 --no-transfer-progress install -DskipTests
              mvn -s .circleci/mvn-settings.xml -T4 --no-transfer-progress -pl qqq-middleware-javalin package appassembler:assemble -DskipTests
              qqq-middleware-javalin/target/appassembler/bin/ValidateApiVersions -r $(pwd)

  mvn_jar_deploy:
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Debug effective settings 
          command: |
            mvn -s .circleci/mvn-settings.xml -B help:effective-settings -Doutput=effective-settings.xml
            grep -n "<id>central</id>" effective-settings.xml || true
            gpg --batch --list-secret-keys --keyid-format=long
      - run:
          name: Setup GPG for signing
          command: |
            mkdir -p ~/.gnupg
            echo 'pinentry-mode loopback' > ~/.gnupg/gpg.conf
            chmod 600 ~/.gnupg/gpg.conf
            echo $GPG_PRIVATE_KEY_B64| tr -d ' \r\n\t' | base64 -d | gpg --batch --import 
      - run:
          name: Publish to Sonatype Central (releases and SNAPSHOTs)
          command: |
            mvn -s .circleci/mvn-settings.xml -P release -B -DskipTests -Dgpg.keyname=$GPG_KEYNAME -Dgpg.passphrase=$GPG_PASSPHRASE deploy
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

  install_asciidoctor:
    steps:
      - checkout
      - run:
          name: Install asciidoctor
          command: |
            sudo apt-get update
            sudo apt install -y asciidoctor

  run_asciidoctor:
    steps:
      - run:
          name: Run asciidoctor
          command: |
            cd docs
            asciidoctor -a docinfo=shared index.adoc
      - store_artifacts:
          path: docs/index.html
          when: always

jobs:
  build:
    executor: localstack/default
    steps:
      - mvn_build

  test:
    executor: localstack/default
    steps:
      - mvn_verify

  api_version_check:
    executor: localstack/default
    steps:
      - check_middleware_api_versions

  mvn_deploy:
    executor: localstack/default
    steps:
      - mvn_build
      - mvn_verify
      - check_middleware_api_versions
      - mvn_jar_deploy

  publish_rc:
    executor: localstack/default
    steps:
      - mvn_build
      - mvn_verify
      - check_middleware_api_versions
      - mvn_jar_deploy 

  publish_release:
    executor: localstack/default
    steps:
      - mvn_build
      - mvn_verify
      - check_middleware_api_versions
      - mvn_jar_deploy

  publish_hotfix:
    executor: localstack/default
    steps:
      - mvn_build
      - mvn_verify
      - check_middleware_api_versions
      - mvn_jar_deploy

  publish_asciidoc:
    executor: localstack/default
    steps:
      - install_asciidoctor
      - run_asciidoctor

workflows:
  test_only:
    jobs:
      - build:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          filters:
            branches:
              ignore: /(develop|main|release/.*|hotfix/.*|integration.*)/
            tags:
              ignore: /(version|snapshot)-.*/
      - test:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          requires:
            - build
          filters:
            branches:
              ignore: /(develop|main|release/.*|hotfix/.*|integration.*)/
            tags:
              ignore: /(version|snapshot)-.*/
      - api_version_check:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          requires:
            - build
          filters:
            branches:
              ignore: /(develop|main|release/.*|hotfix/.*|integration.*)/
            tags:
              ignore: /(version|snapshot)-.*/

  deploy_snapshot:
    jobs:
      - mvn_deploy:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          filters:
            branches:
              only: develop
      - publish_asciidoc:
          filters:
            branches:
              only: develop

  release_candidate:
    jobs:
      - publish_rc:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          filters:
            branches:
              only: /release\/.*/

  production_release:
    jobs:
      - publish_release:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          filters:
            branches:
              only: main
            tags:
              only: /v.*/

  hotfix_release:
    jobs:
      - publish_hotfix:
          context: [ qqq-maven-registry-credentials, build-qqq-sample-app ]
          filters:
            branches:
              only: /hotfix\/.*/
